<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customize Bangs - Und*ck</title>
  <link rel="icon" type="image/svg+xml" href="/search.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="anonymous">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" media="print" onload="this.media='all'">
  <script defer data-domain="unduck.link" src="https://plausible.io/js/script.js"></script>
  <style>
    /* @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"); */

    /* Font fallback that closely matches Inter metrics */
    @font-face {
      font-family: "Inter Fallback";
      size-adjust: 107%;
      ascent-override: 90%;
      src: local("Arial");
    }

    :root {
      font-family:
        Inter,
        "Inter Fallback",
        system-ui,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        Roboto,
        Oxygen,
        Ubuntu,
        Cantarell,
        "Open Sans",
        "Helvetica Neue",
        sans-serif;
      font-synthesis: none;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      width: 100%;
    }

    body {
      line-height: 1.5;
      font-weight: 400;
      font-size: 16px;
      color: #1a1a1a;
      background-color: #fff;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-weight: 600;
      line-height: 1.2;
    }

    a {
      color: #444444;
      text-decoration: none;
    }

    a:hover {
      color: #888888;
    }

    button {
      font: inherit;
      border: none;
      background: none;
      cursor: pointer;
    }

    input,
    textarea,
    select {
      font: inherit;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .header h1 {
      font-size: 2rem;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-box {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
    }

    .btn {
      padding: 10px 15px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn:hover {
      background-color: #e0e0e0;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background-color: #0069d9;
    }

    .bangs-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .bangs-table th,
    .bangs-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .bangs-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }

    .bangs-table tr:hover {
      background-color: #f5f5f5;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      font-size: 1.5rem;
      cursor: pointer;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
      color: #666;
      font-size: 14px;
    }

    @media (prefers-color-scheme: dark) {
      body {
        color: #ddd;
        background-color: #131313;
      }

      a {
        color: #a9a9a9;
      }

      a:hover {
        color: #888;
      }

      .btn {
        background-color: #222;
        border-color: #3d3d3d;
        color: #ddd;
      }

      .btn:hover {
        background-color: #333;
      }

      .bangs-table th {
        background-color: #191919;
      }

      .bangs-table tr:hover {
        background-color: #191919;
      }

      .form-group input,
      .form-group textarea {
        border-color: #3d3d3d;
        background-color: #191919;
        color: #fff;
      }

      .modal-content {
        background-color: #191919;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Customize Bangs</h1>
      <div>
        <a href="/" class="btn">Back to Search</a>
      </div>
    </div>

    <div class="controls">
      <input type="text" id="searchInput" class="search-box" placeholder="Search bangs...">
      <button id="addBangBtn" class="btn btn-primary">Add New Bang</button>
      <button id="importBtn" class="btn">Import Bangs</button>
      <button id="exportBtn" class="btn">Export Bangs</button>
      <button id="importDefaultBtn" class="btn">Import Default Bangs</button>
    </div>

    <table class="bangs-table">
      <thead>
        <tr>
          <th>Bang</th>
          <th>Name</th>
          <th>URL</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="bangsTableBody">
        <!-- Bangs will be populated here -->
      </tbody>
    </table>

    <div class="footer">
      <p>Customize your search experience with Und*ck</p>
    </div>
  </div>

  <!-- Add/Edit Bang Modal -->
  <div id="bangModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Bang</h2>
        <span class="close-btn">&times;</span>
      </div>
      <form id="bangForm">
        <input type="hidden" id="editIndex">
        <div class="form-group">
          <label for="bangKey">Bang Key (e.g., "g" for !g)</label>
          <input type="text" id="bangKey" required>
        </div>
        <div class="form-group">
          <label for="bangName">Name</label>
          <input type="text" id="bangName" required>
        </div>
        <div class="form-group">
          <label for="bangUrl">URL (use {{{s}}} for search term)</label>
          <textarea id="bangUrl" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label for="bangDomain">Domain</label>
          <input type="text" id="bangDomain">
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Import Bangs</h2>
        <span class="close-btn">&times;</span>
      </div>
      <div class="form-group">
        <label for="importFile">Select JSON file with bangs:</label>
        <input type="file" id="importFile" accept=".json">
      </div>
      <div class="actions">
        <button id="importSubmitBtn" class="btn btn-primary">Import</button>
        <button type="button" class="btn" id="importCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Load bangs from localStorage or use default
    let customBangs = JSON.parse(localStorage.getItem('customBangs') || '[]');
    let defaultBangs = []; // Will be loaded from bang.ts
    
    // For now, we'll simulate loading default bangs
    // In a real implementation, you'd import them from bang.ts
    defaultBangs = [
      { t: "q", s: "Qwant", u: "https://www.qwant.com/?q={{{s}}}", d: "www.qwant.com" },
      { t: "g", s: "Google", u: "https://www.google.com/search?q={{{s}}}", d: "www.google.com" },
      { t: "ddg", s: "DuckDuckGo", u: "https://duckduckgo.com/?q={{{s}}}", d: "duckduckgo.com" },
      // Add more default bangs as needed
    ];

    // Import default bangs button
    const importDefaultBtn = document.getElementById('importDefaultBtn');
    
    // Function to import default bangs to Supabase
    async function importDefaultBangs() {
      if (!confirm('Are you sure you want to import all default bangs to the database? This may take a while.')) {
        return;
      }
      
      try {
        // Show loading indicator
        importDefaultBtn.textContent = 'Importing...';
        importDefaultBtn.disabled = true;
        
        // Fetch bangs from bangs.json
        const response = await fetch('/bangs.json');
        const bangs = await response.json();
        
        // Initialize Supabase client
        const { createClient } = await import('@supabase/supabase-js');
        const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
        const supabaseKey = import.meta.env.VITE_SUPABASE_KEY;
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        // Insert bangs in batches to avoid timeouts
        const batchSize = 1000;
        for (let i = 0; i < bangs.length; i += batchSize) {
          const batch = bangs.slice(i, i + batchSize);
          const { error } = await supabase
            .from('bangs')
            .insert(batch.map(bang => ({
              key: bang.t,
              name: bang.s,
              url: bang.u,
              domain: bang.d,
              category: bang.c,
              subcategory: bang.sc,
              rank: bang.r
            })));
            
          if (error) {
            throw error;
          }
          
          // Update progress
          const progress = Math.min(((i + batchSize) / bangs.length) * 100, 100);
          importDefaultBtn.textContent = `Importing... ${Math.round(progress)}%`;
        }
        
        alert('Default bangs imported successfully!');
      } catch (error) {
        console.error('Error importing default bangs:', error);
        alert('Error importing default bangs: ' + error.message);
      } finally {
        // Reset button
        importDefaultBtn.textContent = 'Import Default Bangs';
        importDefaultBtn.disabled = false;
      }
    }
    
    // Add event listener to import default bangs button
    importDefaultBtn.addEventListener('click', importDefaultBangs);
    
    // Merge default and custom bangs
    let allBangs = [...defaultBangs, ...customBangs];
    
    // DOM Elements
    const bangsTableBody = document.getElementById('bangsTableBody');
    const searchInput = document.getElementById('searchInput');
    const addBangBtn = document.getElementById('addBangBtn');
    const importBtn = document.getElementById('importBtn');
    const exportBtn = document.getElementById('exportBtn');
    const bangModal = document.getElementById('bangModal');
    const importModal = document.getElementById('importModal');
    const bangForm = document.getElementById('bangForm');
    const modalTitle = document.getElementById('modalTitle');
    const editIndexInput = document.getElementById('editIndex');
    const bangKeyInput = document.getElementById('bangKey');
    const bangNameInput = document.getElementById('bangName');
    const bangUrlInput = document.getElementById('bangUrl');
    const bangDomainInput = document.getElementById('bangDomain');
    const closeBtns = document.querySelectorAll('.close-btn');
    const cancelBtn = document.getElementById('cancelBtn');
    const importCancelBtn = document.getElementById('importCancelBtn');
    const importSubmitBtn = document.getElementById('importSubmitBtn');
    const importFileInput = document.getElementById('importFile');
    
    // Render bangs table
    function renderBangsTable(bangs = allBangs) {
      bangsTableBody.innerHTML = '';
      
      bangs.forEach((bang, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>!${bang.t}</td>
          <td>${bang.s}</td>
          <td>${bang.u}</td>
          <td>
            <button class="btn edit-btn" data-index="${index}">Edit</button>
            <button class="btn delete-btn" data-index="${index}">Delete</button>
          </td>
        `;
        bangsTableBody.appendChild(row);
      });
      
      // Add event listeners to edit and delete buttons
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          openEditModal(index);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          deleteBang(index);
        });
      });
    }
    
    // Filter bangs based on search input
    function filterBangs() {
      const searchTerm = searchInput.value.toLowerCase();
      const filteredBangs = allBangs.filter(bang => 
        bang.t.toLowerCase().includes(searchTerm) || 
        bang.s.toLowerCase().includes(searchTerm) ||
        bang.u.toLowerCase().includes(searchTerm)
      );
      renderBangsTable(filteredBangs);
    }
    
    // Open add modal
    function openAddModal() {
      modalTitle.textContent = 'Add New Bang';
      bangForm.reset();
      editIndexInput.value = '';
      bangModal.style.display = 'flex';
    }
    
    // Open edit modal
    function openEditModal(index) {
      const bang = allBangs[index];
      modalTitle.textContent = 'Edit Bang';
      bangKeyInput.value = bang.t;
      bangNameInput.value = bang.s;
      bangUrlInput.value = bang.u;
      bangDomainInput.value = bang.d || '';
      editIndexInput.value = index;
      bangModal.style.display = 'flex';
    }
    
    // Close modals
    function closeModals() {
      bangModal.style.display = 'none';
      importModal.style.display = 'none';
    }
    
    // Save bang (add or edit)
    function saveBang(e) {
      e.preventDefault();
      
      const index = editIndexInput.value;
      const bang = {
        t: bangKeyInput.value,
        s: bangNameInput.value,
        u: bangUrlInput.value,
        d: bangDomainInput.value
      };
      
      if (index === '') {
        // Add new bang
        customBangs.push(bang);
      } else {
        // Edit existing bang
        customBangs[parseInt(index) - defaultBangs.length] = bang;
      }
      
      // Save to localStorage
      localStorage.setItem('customBangs', JSON.stringify(customBangs));
      
      // Refresh bangs
      allBangs = [...defaultBangs, ...customBangs];
      renderBangsTable();
      closeModals();
    }
    
    // Delete bang
    function deleteBang(index) {
      if (index < defaultBangs.length) {
        alert('Cannot delete default bangs');
        return;
      }
      
      if (confirm('Are you sure you want to delete this bang?')) {
        customBangs.splice(index - defaultBangs.length, 1);
        localStorage.setItem('customBangs', JSON.stringify(customBangs));
        allBangs = [...defaultBangs, ...customBangs];
        renderBangsTable();
      }
    }
    
    // Export bangs
    function exportBangs() {
      const dataStr = JSON.stringify(customBangs, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = 'unduck-bangs.json';
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }
    
    // Import bangs
    function openImportModal() {
      importFileInput.value = '';
      importModal.style.display = 'flex';
    }
    
    // Handle file import
    function importBangs() {
      const file = importFileInput.files[0];
      if (!file) {
        alert('Please select a file');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedBangs = JSON.parse(e.target.result);
          if (Array.isArray(importedBangs)) {
            customBangs = importedBangs;
            localStorage.setItem('customBangs', JSON.stringify(customBangs));
            allBangs = [...defaultBangs, ...customBangs];
            renderBangsTable();
            closeModals();
            alert('Bangs imported successfully!');
          } else {
            alert('Invalid file format');
          }
        } catch (error) {
          alert('Error parsing file: ' + error.message);
        }
      };
      reader.readAsText(file);
    }
    
    // Event Listeners
    searchInput.addEventListener('input', filterBangs);
    addBangBtn.addEventListener('click', openAddModal);
    importBtn.addEventListener('click', openImportModal);
    exportBtn.addEventListener('click', exportBangs);
    bangForm.addEventListener('submit', saveBang);
    cancelBtn.addEventListener('click', closeModals);
    importCancelBtn.addEventListener('click', closeModals);
    importSubmitBtn.addEventListener('click', importBangs);
    
    closeBtns.forEach(btn => {
      btn.addEventListener('click', closeModals);
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target === bangModal || e.target === importModal) {
        closeModals();
      }
    });
    
    // Initial render
    renderBangsTable();
  </script>
</body>
</html>